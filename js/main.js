

var web3 = require('web3');
var contractAbi;
var contractAddress = '';

$(document).ready( () =>
{ 
  /* set up the working variables */
  var contract =
  {
    abi: [{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatClaim","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_avatarUrl","type":"string"},{"name":"_message","type":"string"}],"name":"buySeat","outputs":[{"name":"","type":"uint256"}],"payable":true,"type":"function"},{"constant":true,"inputs":[],"name":"lastBurn","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnRate","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatAvatarUrl","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnTime","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatMessage","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"}],
    bytecode: '60606040526000600055341561001157fe5b5b610924806100216000396000f300606060405236156100675763ffffffff60e060020a6000350416631598b2e0811461006957806374652c301461008e578063bbce2c171461012b578063bed998501461014d578063e537a1951461016f578063ebf6cf9b14610202578063fbb8932a14610224575bfe5b341561007157fe5b61007c6004356102b7565b60408051918252519081900360200190f35b61007c600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496506102da95505050505050565b60408051918252519081900360200190f35b341561013357fe5b61007c610336565b60408051918252519081900360200190f35b341561015557fe5b61007c61033c565b60408051918252519081900360200190f35b341561017757fe5b610182600435610342565b6040805160208082528351818301528351919283929083019185019080838382156101c8575b8051825260208311156101c857601f1990920191602091820191016101a8565b505050905090810190601f1680156101f45780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561020a57fe5b61007c6103f3565b60408051918252519081900360200190f35b341561022c57fe5b6101826004356103fa565b6040805160208082528351818301528351919283929083019185019080838382156101c8575b8051825260208311156101c857601f1990920191602091820191016101a8565b505050905090810190601f1680156101f45780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000600282600581106102c657fe5b6004020160005b506003015490505b919050565b6000348190116102e657fe5b6102f083836104aa565b6102f861078d565b604051738bb00852623184d534d9805c66ed85b1d8ec0f52903480156108fc02916000818181858888f19350505050151561032f57fe5b5b92915050565b60015481565b60005481565b61034a610846565b6002826005811061035757fe5b6004020160005b5060019081018054604080516020600295841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156103e65780601f106103bb576101008083540402835291602001916103e6565b820191906000526020600020905b8154815290600101906020018083116103c957829003601f168201915b505050505090505b919050565b62278d0081565b610402610846565b6002826005811061040f57fe5b6004020160005b50600290810180546040805160206001841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156103e65780601f106103bb576101008083540402835291602001916103e6565b820191906000526020600020905b8154815290600101906020018083116103c957829003601f168201915b505050505090505b919050565b600080805b8060ff1660051115610691576104df600260ff8316600581106104ce57fe5b6004020160005b50600301546107fb565b600260ff8316600581106104ef57fe5b6004020160005b50600301558115801561052d5750600260ff82166005811061051457fe5b6004020160005b505433600160a060020a039081169116145b1561055e5734600260ff83166005811061054357fe5b6004020160005b506003018054909101905560019150610686565b600260ff84166005811061056e57fe5b6004020160005b5060030154600260ff83166005811061058a57fe5b6004020160005b506003015410156105a457809250610686565b600260ff8216600581106105b457fe5b6004020160005b50600301541515610686576000600260ff8316600581106105d857fe5b6004020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055604080516020810190915260008152600260ff83166005811061062a57fe5b6004020160005b5081516106479260019092019160200190610858565b50604080516020810190915260008152600260ff83166005811061066757fe5b6004020160005b5081516106849260029092019160200190610858565b505b5b5b5b6001016104af565b81151561078457600260ff8416600581106106a857fe5b6004020160005b5060030154341061077e5734600260ff8516600581106106cb57fe5b6004020160005b506003015533600260ff8516600581106106e857fe5b6004020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039290921691909117905584600260ff85166005811061072c57fe5b6004020160005b5081516107499260019092019160200190610858565b5083600260ff85166005811061075b57fe5b6004020160005b5081516107789260029092019160200190610858565b50610784565b60006000fd5b5b5b5050505050565b3460015b8060ff16600511156107e85781600260ff8316600581106107ae57fe5b6004020160005b506003015411156107df57600260ff8216600581106107d057fe5b6004020160005b506003015491505b5b600101610791565b62278d00825b04600055426001555b5050565b600060006001544214156108115782915061083f565b600154421161081c57fe5b60015442036000540290508281101515610839576000915061083f565b80830391505b5b50919050565b60408051602081019091526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061089957805160ff19168380011785556108c6565b828001600101855582156108c6579182015b828111156108c65782518255916020019190600101906108ab565b5b506108d39291506108d7565b5090565b6108f591905b808211156108d357600081556001016108dd565b5090565b905600a165627a7a723058208aa9d5abebedc3b8dc7e54a54ce12241508810ce418c00cd74cec7c935dbdc050029',
  };

  web3 = new web3();
  var Contract = web3.eth.contract( contract.abi );

  /* run the application */
  function main()
  {
    etherRiche = new models.EtherRiche( { contract: Contract.at(contractAddress) } );

    var view = new views.EtherSeats( { el:'#etherSeats', model:etherRiche } ).render();
    etherRiche.fetch();
  }



  /* Demo Setup */

  if( _hasUrlParam('demo') )
  {
    /* setup the demo */
    console.info( 'setting up demo.' );
    _demoSetup();
  }
  else
  {
    /* run the real thing */
    main();
  }

  function _hasUrlParam( param )
  {
    var search = decodeURIComponent( window.location.href.slice( window.location.href.indexOf('?') + 1 ) );
    var tokens = search.split( '&' );
    var map = {};
    tokens.forEach( ( val, i ) =>
    {
      var parts = val.split( '=', 2 );
      map[parts[0]] = parts[1] || true;
    });

    return( map[param] );
  }

  var accounts;

  function _demoSetup()
  {
    var provider = new web3.providers.HttpProvider('http://localhost:8545');
    web3.setProvider( provider );

    web3.eth.getAccounts( (_err, _accounts ) =>
    {
      if( ! _err )
      {
        accounts = _accounts;
        _createContract();
      }
    });
  }

  function _createContract()
  {
    Contract.new(
      {
        from: accounts[0],
        data: contract.bytecode,
        gas: 4E6,
      },
      ( _err, _contract ) =>
      {
        if( ( ! _err ) && ( _contract.address ) )
        {
          contractAddress = _contract.address;
          _claimSeat();
        }
      }
    );
  }

  function _claimSeat()
  {
    let avatarUrl = 'http://vignette2.wikia.nocookie.net/pvx/images/b/b5/Misery_Cow.png/revision/latest?cb=20090217232925';
    let message = 'Hello World';
    Contract.at( contractAddress ).buySeat( avatarUrl, message,
        {
          from: accounts[0],
          value: 200,
          gas: 4E6
        },
        ( _err, _result ) =>
        {
          if( ! _err )
          {
            main();
          }
        }
    );
  }
}
);


