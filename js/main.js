

var web3 = require('web3');
var contractAbi;
var contractAddress = '';
var etherRiche;
var router;

$(document).ready( () =>
{ 
  /* set up the working variables */
  var contract =
  {
    abi: [{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatClaim","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_avatarUrl","type":"string"},{"name":"_message","type":"string"},{"name":"_messageUrl","type":"string"}],"name":"buySeat","outputs":[{"name":"","type":"uint256"}],"payable":true,"type":"function"},{"constant":true,"inputs":[],"name":"lastBurn","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnRate","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatAvatarUrl","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnTime","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatMessageUrl","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatMessage","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"}],
    bytecode: '60606040526000600055341561001157fe5b5b610b1f806100216000396000f300606060405236156100725763ffffffff60e060020a6000350416631598b2e0811461007457806361b9c9f414610099578063bbce2c1714610173578063bed9985014610195578063e537a195146101b7578063ebf6cf9b1461024a578063f14ff5cf1461026c578063fbb8932a146102ff575bfe5b341561007c57fe5b610087600435610392565b60408051918252519081900360200190f35b610087600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496506103b595505050505050565b60408051918252519081900360200190f35b341561017b57fe5b610087610413565b60408051918252519081900360200190f35b341561019d57fe5b610087610419565b60408051918252519081900360200190f35b34156101bf57fe5b6101ca60043561041f565b604080516020808252835181830152835191928392908301918501908083838215610210575b80518252602083111561021057601f1990920191602091820191016101f0565b505050905090810190601f16801561023c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561025257fe5b6100876104d0565b60408051918252519081900360200190f35b341561027457fe5b6101ca6004356104d7565b604080516020808252835181830152835191928392908301918501908083838215610210575b80518252602083111561021057601f1990920191602091820191016101f0565b505050905090810190601f16801561023c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561030757fe5b6101ca600435610588565b604080516020808252835181830152835191928392908301918501908083838215610210575b80518252602083111561021057601f1990920191602091820191016101f0565b505050905090810190601f16801561023c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000600282600581106103a157fe5b6005020160005b506004015490505b919050565b6000348190116103c157fe5b6103cc848484610638565b6103d4610988565b604051738bb00852623184d534d9805c66ed85b1d8ec0f52903480156108fc02916000818181858888f19350505050151561040b57fe5b5b9392505050565b60015481565b60005481565b610427610a41565b6002826005811061043457fe5b6005020160005b5060019081018054604080516020600295841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156104c35780601f10610498576101008083540402835291602001916104c3565b820191906000526020600020905b8154815290600101906020018083116104a657829003601f168201915b505050505090505b919050565b62278d0081565b6104df610a41565b600282600581106104ec57fe5b6005020160005b50600301805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156104c35780601f10610498576101008083540402835291602001916104c3565b820191906000526020600020905b8154815290600101906020018083116104a657829003601f168201915b505050505090505b919050565b610590610a41565b6002826005811061059d57fe5b6005020160005b50600290810180546040805160206001841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156104c35780601f10610498576101008083540402835291602001916104c3565b820191906000526020600020905b8154815290600101906020018083116104a657829003601f168201915b505050505090505b919050565b600080805b8060ff166005111561085c5761066d600260ff83166005811061065c57fe5b6005020160005b50600401546109f6565b600260ff83166005811061067d57fe5b6005020160005b5060040155811580156106bb5750600260ff8216600581106106a257fe5b6005020160005b505433600160a060020a039081169116145b156106ec5734600260ff8316600581106106d157fe5b6005020160005b506004018054909101905560019150610851565b600260ff8416600581106106fc57fe5b6005020160005b5060040154600260ff83166005811061071857fe5b6005020160005b5060040154101561073257809250610851565b600260ff82166005811061074257fe5b6005020160005b50600401541515610851576000600260ff83166005811061076657fe5b6005020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055604080516020810190915260008152600260ff8316600581106107b857fe5b6005020160005b5081516107d59260019092019160200190610a53565b50604080516020810190915260008152600260ff8316600581106107f557fe5b6005020160005b5081516108129260029092019160200190610a53565b50604080516020810190915260008152600260ff83166005811061083257fe5b6005020160005b50815161084f9260039092019160200190610a53565b505b5b5b5b60010161063d565b81151561097e57600260ff84166005811061087357fe5b6005020160005b506004015434106109785734600260ff85166005811061089657fe5b6005020160005b506004015533600260ff8516600581106108b357fe5b6005020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039290921691909117905585600260ff8516600581106108f757fe5b6005020160005b5081516109149260019092019160200190610a53565b5084600260ff85166005811061092657fe5b6005020160005b5081516109439260029092019160200190610a53565b5083600260ff85166005811061095557fe5b6005020160005b5081516109729260039092019160200190610a53565b5061097e565b60006000fd5b5b5b505050505050565b3460015b8060ff16600511156109e35781600260ff8316600581106109a957fe5b6005020160005b506004015411156109da57600260ff8216600581106109cb57fe5b6005020160005b506004015491505b5b60010161098c565b62278d00825b04600055426001555b5050565b60006000600154421415610a0c57829150610a3a565b6001544211610a1757fe5b60015442036000540290508281101515610a345760009150610a3a565b80830391505b5b50919050565b60408051602081019091526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610a9457805160ff1916838001178555610ac1565b82800160010185558215610ac1579182015b82811115610ac1578251825591602001919060010190610aa6565b5b50610ace929150610ad2565b5090565b610af091905b80821115610ace5760008155600101610ad8565b5090565b905600a165627a7a72305820ca4ac65cadeab9dd1e500f884b8e8caba4221a6d942eb3573aff5f1255c370a10029',
  };

  web3 = new web3();
  var Contract = web3.eth.contract( contract.abi );

  /* run the application */
  function main()
  {
    /* create the model */
    etherRiche = new models.EtherRiche( { contract: Contract.at(contractAddress) } );

    /* setup the router */
    router = new Router();
    Backbone.history.start();
  }



  /* Demo Setup */

  if( _hasUrlParam('demo') )
  {
    /* setup the demo */
    console.info( 'setting up demo.' );
    _demoSetup();
  }
  else
  {
    /* run the real thing */
    main();
  }

  function _hasUrlParam( param )
  {
    var search = decodeURIComponent( window.location.href.slice( window.location.href.indexOf('?') + 1 ) );
    var tokens = search.split( '&' );
    var map = {};
    tokens.forEach( ( val, i ) =>
    {
      var parts = val.split( '=', 2 );
      map[parts[0]] = parts[1] || true;
    });

    return( map[param] );
  }

  var accounts;

  function _demoSetup()
  {
    var provider = new web3.providers.HttpProvider('http://localhost:8545');
    web3.setProvider( provider );

    web3.eth.getAccounts( (_err, _accounts ) =>
    {
      if( ! _err )
      {
        accounts = _accounts;
        _createContract();
      }
    });
  }

  function _createContract()
  {
    Contract.new(
      {
        from: accounts[0],
        data: contract.bytecode,
        gas: 4E6,
      },
      ( _err, _contract ) =>
      {
        if( ( ! _err ) && ( _contract.address ) )
        {
          contractAddress = _contract.address;
          _claimSeat();
        }
      }
    );
  }

  function _claimSeat()
  {
    let avatarUrl = 'http://vignette2.wikia.nocookie.net/pvx/images/b/b5/Misery_Cow.png/revision/latest?cb=20090217232925';
    let message = 'Hello World <script> window.location = "http://disney.com"; </script> http://test.com';
    let messageUrl = 'http://disney.com';
    Contract.at( contractAddress ).buySeat( avatarUrl, message, messageUrl,
        {
          from: accounts[0],
          value: 200,
          gas: 4E6
        },
        ( _err, _result ) =>
        {
          if( _result )
          {
            main();
          }
        }
    );
  }
}
);


