

var web3 = require('web3');
var contractAbi;
var contractAddress = '';

/* global model of the current contract state */
var etherRiche;

/* test accounts */
var accounts;

$(document).ready( () =>
{ 
  /* set up the working variables */
  var contract =
  {
    abi: [{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatClaim","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_avatarUrl","type":"string"},{"name":"_message","type":"string"},{"name":"_messageUrl","type":"string"}],"name":"buySeat","outputs":[{"name":"","type":"uint256"}],"payable":true,"type":"function"},{"constant":true,"inputs":[],"name":"lastBurn","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnRate","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatAvatarUrl","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"burnTime","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatMessageUrl","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatAddress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getSeatMessage","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"}],
    bytecode: '60606040526000600055341561001157fe5b5b610b82806100216000396000f3006060604052361561007d5763ffffffff60e060020a6000350416631598b2e0811461007f57806361b9c9f4146100a4578063bbce2c171461017e578063bed99850146101a0578063e537a195146101c2578063ebf6cf9b14610255578063f14ff5cf14610277578063fb3862161461030a578063fbb8932a14610339575bfe5b341561008757fe5b6100926004356103cc565b60408051918252519081900360200190f35b610092600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284375050604080516020601f89358b0180359182018390048302840183019094528083529799988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979998810197919650918201945092508291508401838280828437509496506103ef95505050505050565b60408051918252519081900360200190f35b341561018657fe5b61009261044d565b60408051918252519081900360200190f35b34156101a857fe5b610092610453565b60408051918252519081900360200190f35b34156101ca57fe5b6101d5600435610459565b60408051602080825283518183015283519192839290830191850190808383821561021b575b80518252602083111561021b57601f1990920191602091820191016101fb565b505050905090810190601f1680156102475780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561025d57fe5b61009261050a565b60408051918252519081900360200190f35b341561027f57fe5b6101d5600435610511565b60408051602080825283518183015283519192839290830191850190808383821561021b575b80518252602083111561021b57601f1990920191602091820191016101fb565b505050905090810190601f1680156102475780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561031257fe5b61031d6004356105c2565b60408051600160a060020a039092168252519081900360200190f35b341561034157fe5b6101d56004356105eb565b60408051602080825283518183015283519192839290830191850190808383821561021b575b80518252602083111561021b57601f1990920191602091820191016101fb565b505050905090810190601f1680156102475780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000600282600581106103db57fe5b6005020160005b506004015490505b919050565b6000348190116103fb57fe5b61040684848461069b565b61040e6109eb565b604051738bb00852623184d534d9805c66ed85b1d8ec0f52903480156108fc02916000818181858888f19350505050151561044557fe5b5b9392505050565b60015481565b60005481565b610461610aa4565b6002826005811061046e57fe5b6005020160005b5060019081018054604080516020600295841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156104fd5780601f106104d2576101008083540402835291602001916104fd565b820191906000526020600020905b8154815290600101906020018083116104e057829003601f168201915b505050505090505b919050565b62278d0081565b610519610aa4565b6002826005811061052657fe5b6005020160005b50600301805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156104fd5780601f106104d2576101008083540402835291602001916104fd565b820191906000526020600020905b8154815290600101906020018083116104e057829003601f168201915b505050505090505b919050565b6000600282600581106105d157fe5b6005020160005b5054600160a060020a031690505b919050565b6105f3610aa4565b6002826005811061060057fe5b6005020160005b50600290810180546040805160206001841615610100026000190190931694909404601f8101839004830285018301909152808452908301828280156104fd5780601f106104d2576101008083540402835291602001916104fd565b820191906000526020600020905b8154815290600101906020018083116104e057829003601f168201915b505050505090505b919050565b600080805b8060ff16600511156108bf576106d0600260ff8316600581106106bf57fe5b6005020160005b5060040154610a59565b600260ff8316600581106106e057fe5b6005020160005b50600401558115801561071e5750600260ff82166005811061070557fe5b6005020160005b505433600160a060020a039081169116145b1561074f5734600260ff83166005811061073457fe5b6005020160005b5060040180549091019055600191506108b4565b600260ff84166005811061075f57fe5b6005020160005b5060040154600260ff83166005811061077b57fe5b6005020160005b50600401541015610795578092506108b4565b600260ff8216600581106107a557fe5b6005020160005b506004015415156108b4576000600260ff8316600581106107c957fe5b6005020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055604080516020810190915260008152600260ff83166005811061081b57fe5b6005020160005b5081516108389260019092019160200190610ab6565b50604080516020810190915260008152600260ff83166005811061085857fe5b6005020160005b5081516108759260029092019160200190610ab6565b50604080516020810190915260008152600260ff83166005811061089557fe5b6005020160005b5081516108b29260039092019160200190610ab6565b505b5b5b5b6001016106a0565b8115156109e157600260ff8416600581106108d657fe5b6005020160005b506004015434106109db5734600260ff8516600581106108f957fe5b6005020160005b506004015533600260ff85166005811061091657fe5b6005020160005b50805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039290921691909117905585600260ff85166005811061095a57fe5b6005020160005b5081516109779260019092019160200190610ab6565b5084600260ff85166005811061098957fe5b6005020160005b5081516109a69260029092019160200190610ab6565b5083600260ff8516600581106109b857fe5b6005020160005b5081516109d59260039092019160200190610ab6565b506109e1565b60006000fd5b5b5b505050505050565b3460015b8060ff1660051115610a465781600260ff831660058110610a0c57fe5b6005020160005b50600401541115610a3d57600260ff821660058110610a2e57fe5b6005020160005b506004015491505b5b6001016109ef565b62278d00825b04600055426001555b5050565b60006000600154421415610a6f57829150610a9d565b6001544211610a7a57fe5b60015442036000540290508281101515610a975760009150610a9d565b80830391505b5b50919050565b60408051602081019091526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610af757805160ff1916838001178555610b24565b82800160010185558215610b24579182015b82811115610b24578251825591602001919060010190610b09565b5b50610b31929150610b35565b5090565b610b5391905b80821115610b315760008155600101610b3b565b5090565b905600a165627a7a72305820f992ced300b10da313322e9325571a1f87da2175818a0b931f0cf5c475e9318a0029',
  };

  web3 = new web3();
  var Contract = web3.eth.contract( contract.abi );

  /* run the application */
  function main()
  {
    /* create the model */
    etherRiche = new models.EtherRiche( { contract: Contract.at(contractAddress) } );

    /* setup the router */
    new Router();
    Backbone.history.start();
  }



  /* Demo Setup */

  if( _hasUrlParam('demo') )
  {
    /* setup the demo */
    console.info( 'setting up demo.' );
    _demoSetup();
  }
  else
  {
    /* run the real thing */
    main();
  }

  function _hasUrlParam( param )
  {
    var search = decodeURIComponent( window.location.href.slice( window.location.href.indexOf('?') + 1 ) );
    var tokens = search.split( '&' );
    var map = {};
    tokens.forEach( ( val, i ) =>
    {
      var parts = val.split( '=', 2 );
      map[parts[0]] = parts[1] || true;
    });

    return( map[param] );
  }


  function _demoSetup()
  {
    var provider = new web3.providers.HttpProvider('http://localhost:8545');
    web3.setProvider( provider );

    web3.eth.getAccounts( (_err, _accounts ) =>
    {
      if( ! _err )
      {
        accounts = _accounts;
        _createContract();
      }
    });
  }

  function _createContract()
  {
    Contract.new(
      {
        from: accounts[0],
        data: contract.bytecode,
        gas: 4E6,
      },
      ( _err, _contract ) =>
      {
        if( ( ! _err ) && ( _contract.address ) )
        {
          contractAddress = _contract.address;
          _claimSeat();
        }
      }
    );
  }

  function _claimSeat()
  {
    let avatarUrl = 'http://vignette2.wikia.nocookie.net/pvx/images/b/b5/Misery_Cow.png/revision/latest?cb=20090217232925';
    let message = 'Hello World <script> window.location = "http://disney.com"; </script> http://test.com';
    let messageUrl = 'http://disney.com';
    Contract.at( contractAddress ).buySeat( avatarUrl, message, messageUrl,
        {
          from: accounts[0],
          value: 200,
          gas: 4E6
        },
        ( _err, _result ) =>
        {
          if( _result )
          {
            web3.eth.defaultAccount = accounts[1];
            main();
          }
        }
    );
  }
}
);


